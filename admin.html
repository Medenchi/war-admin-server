<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–ê–¥–º–∏–Ω–∫–∞ | –û—Ç–∑—ã–≤—ã</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:sans-serif;
            background:#111;
            color:#fff;
            line-height:1.6;
            padding:20px;
        }
        .dashboard {
            max-width:500px;
            margin:auto;
            background:#222;
            padding:20px;
            border-radius:10px;
        }
        input, textarea, button {
            width:100%;
            margin-top:10px;
            padding:10px;
            font-size:14px;
        }
        button {
            background:#ff6b6b;
            color:#fff;
            border:none;
            cursor:pointer;
        }
        .block-item {
            background:#333;
            padding:10px;
            margin-bottom:10px;
            border-radius:5px;
        }
        .actions {
            margin-top:10px;
        }
        .hidden {
            display:none !important;
        }
    </style>
</head>
<body>

<div class="dashboard">

    <!-- –í–æ—Ç–µ—Ä–ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–ª–∫–∞ -->
    <h2 style="text-align:center;color:#ff6b6b;">–í–û–¢–ï–†–ü–†–ï–û–ë–†–ê–ó–û–í–ê–õ–ö–ê</h2>
    <input type="file" id="waterImageInput" accept="image/*" onchange="previewWatermarked()">
    
    <select id="targetBlock" onchange="handleTargetSelect()" class="hidden">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
        <option value="reviews">–û—Ç–∑—ã–≤</option>
    </select><br>

    <div style="text-align:center;">
        <p>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:</p>
        <img id="waterPreview" src="" alt="–° –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º" style="display:none;max-width:100%;">
    </div><hr>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ -->
    <div id="form-review" class="hidden">
        <textarea id="reviewText_WM" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞"></textarea>
        <input type="text" id="reviewAuthor_WM" placeholder="–ê–≤—Ç–æ—Ä">
        <input type="number" id="reviewRating_WM" min="1" max="5" step="0.1" placeholder="–†–µ–π—Ç–∏–Ω–≥">
        <button onclick="saveToReview()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ—Ç–∑—ã–≤—ã</button>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ—Ç–∑—ã–≤–æ–≤ -->
    <h2 style="text-align:center;margin-top:30px;color:#ff6b6b;">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ—Ç–∑—ã–≤—ã</h2>
    <div id="reviewsList"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script>
    // üîë Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyCDaptwQubkzkAkHSSi_GpMhRHFasWFXvw",
        authDomain: "moonstudio-db.firebaseapp.com",
        databaseURL: "https://moonstudio-db-default-rtdb.firebaseio.com",
        projectId: "moonstudio-db"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    function refPath(p) { return db.ref(p); }

    let currentWatermarkedData = null;

    // --- –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ ---
    function readFile(e, c) {
        const r = new FileReader();
        r.onload = () => c(r.result);
        r.readAsDataURL(e.target.files[0]);
    }

    // --- –ù–∞–ª–æ–∂–µ–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ ---
    function applyWatermark(url, callback) {
        const cv = document.createElement("canvas");
        const ctx = cv.getContext("2d");

        const img = new Image();
        img.crossOrigin = "Anonymous"; // üîë –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        img.src = url;

        img.onload = () => {
            cv.width = img.width;
            cv.height = img.height;
            ctx.drawImage(img, 0, 0);

            ctx.font = "bold 30px sans-serif";
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.textAlign = "center";

            for (let i = 0; i < 20; i++) {
                const x = Math.random() * cv.width;
                const y = Math.random() * cv.height;
                ctx.fillText("SigmaGamblers", x, y);
            }

            cv.toBlob(blob => {
                const fr = new FileReader();
                fr.onload = () => callback(fr.result);
                fr.readAsDataURL(blob);
            }, "image/png");
        };
    }

    // --- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ ---
    function previewWatermarked() {
        const f = document.getElementById("waterImageInput");
        if (!f.files[0]) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ");

        readFile(f, d => {
            applyWatermark(d, w => {
                document.getElementById("waterPreview").src = w;
                document.getElementById("waterPreview").style.display = "block";
                currentWatermarkedData = w;
            });
        });
    }

    function handleTargetSelect() {
        const block = document.getElementById("targetBlock").value;
        document.querySelectorAll("[id^='form-']").forEach(el => el.classList.add("hidden"));
        if (block === "reviews") {
            document.getElementById("form-review").classList.remove("hidden");
        }
    }

    // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞ ---
    function saveToReview() {
        const t = document.getElementById("reviewText_WM").value.trim();
        const a = document.getElementById("reviewAuthor_WM").value.trim();
        const r = parseFloat(document.getElementById("reviewRating_WM").value.trim());

        if (!t || !a || !r || !currentWatermarkedData) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ");

        const id = Date.now();
        refPath(`reviews/${id}`).set({ text:t, author:a, rating:r, image:currentWatermarkedData }, () => {
            alert("–û—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω"); loadReviews();
            clearFields(["reviewText_WM", "reviewAuthor_WM", "reviewRating_WM"]);
            document.getElementById("waterImageInput").value = "";
            document.getElementById("form-review").classList.add("hidden");
            document.getElementById("waterPreview").style.display = "none";
            currentWatermarkedData = null;
        });
    }

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ ---
    function loadReviews() {
        refPath("reviews").on("value", snap => {
            const container = document.getElementById("reviewsList");
            container.innerHTML = "<h3>–û—Ç–∑—ã–≤—ã</h3>";

            if (!snap.exists()) return;

            snap.forEach(child => {
                const d = child.val();
                const div = document.createElement("div");
                div.className = "block-item";
                div.innerHTML = `
                    "${d.text}" ‚Äî ${d.author}<br>‚≠ê ${d.rating}<br>
                    <img src="${d.image}" width="100%"><br>
                    <div class="actions">
                        <button onclick="editItem('${child.key}', 'reviews')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button onclick="deleteItem('${child.key}', 'reviews')">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>`;
                container.appendChild(div);
            });
        });
    }

    // --- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ---
    function editItem(id, type) {
        refPath(`${type}/${id}`).once("value", snap => {
            const data = snap.val();
            if (type === "reviews") {
                document.getElementById("reviewText_WM").value = data.text;
                document.getElementById("reviewAuthor_WM").value = data.author;
                document.getElementById("reviewRating_WM").value = data.rating;

                currentWatermarkedData = data.image;
                document.getElementById("form-review").classList.remove("hidden");
            }
        });
    }

    // --- –£–¥–∞–ª–µ–Ω–∏–µ ---
    function deleteItem(id, type) {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã?")) {
            refPath(`${type}/${id}`).remove(() => window[`load${type.charAt(0).toUpperCase()+type.slice(1)]`();
        });
    }

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ ---
    function clearFields(ids) {
        ids.forEach(id => document.getElementById(id).value = "");
    }

    window.onload = () => {
        loadReviews();
        document.getElementById("targetBlock").value = "reviews";
        handleTargetSelect();
    };
</script>
</body>
</html>
