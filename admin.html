<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–ê–¥–º–∏–Ω–∫–∞ | –û—Ç–∑—ã–≤—ã</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet"/>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Montserrat', sans-serif;
            background: #111;
            color: #fff;
            line-height: 1.6;
            padding: 20px;
        }

        .dashboard {
            max-width: 500px;
            margin: auto;
            background: #222;
            padding: 20px;
            border-radius: 10px;
        }

        input, textarea, button, select {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            font-size: 14px;
        }

        button {
            background: #ff6b6b;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        h2.section-title {
            text-align: center;
            margin-bottom: 20px;
            color: #ff6b6b;
        }

        .review-block {
            background: #333;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .actions {
            margin-top: 10px;
        }

        .actions button {
            margin-right: 10px;
            font-size: 14px;
            padding: 6px 10px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

<div class="dashboard">

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ -->
    <h2 class="section-title">–í–û–¢–ï–†–ü–†–ï–û–ë–†–ê–ó–û–í–ê–õ–ö–ê</h2>
    <input type="file" id="waterImageInput" accept="image/*" onchange="previewWatermarked()">
    <select id="targetBlock" onchange="handleTargetSelect()">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</option>
        <option value="reviews">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ –æ—Ç–∑—ã–≤</option>
    </select>

    <div style="text-align:center;">
        <p>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:</p>
        <img id="waterPreview" src="" alt="–° –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º" style="display:none; max-width:100%;">
    </div><hr>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ -->
    <h2 class="section-title">–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h2>
    <textarea id="reviewText_WM" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞"></textarea>
    <input type="text" id="reviewAuthor_WM" placeholder="–ê–≤—Ç–æ—Ä">
    <input type="number" id="reviewRating_WM" min="1" max="5" step="0.1" placeholder="–†–µ–π—Ç–∏–Ω–≥ (1-5)">
    <input type="file" id="reviewImageFile" accept="image/*">
    <button onclick="addReview()">–î–æ–±–∞–≤–∏—Ç—å</button><hr>

    <!-- –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
    <h2 class="section-title">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ—Ç–∑—ã–≤—ã</h2>
    <div id="reviewsList"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script>
    // üîë Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyCDaptwQubkzkAkHSSi_GpMhRHFasWFXvw",
        authDomain: "moonstudio-db.firebaseapp.com",
        databaseURL: "https://moonstudio-db-default-rtdb.firebaseio.com",
        projectId: "moonstudio-db",
        storageBucket: "moonstudio-db.firebasestorage.app"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function refPath(path) {
        return db.ref(path);
    }

    let currentWatermarkedData = null;

    // --- –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ ---
    function readFileAsDataURL(file, callback) {
        const reader = new FileReader();
        reader.onload = e => callback(e.target.result);
        reader.readAsDataURL(file);
    }

    // --- –ù–∞–ª–æ–∂–µ–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ ---
    async function applyWatermark(imageUrl, callback) {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.src = imageUrl;

        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            ctx.font = "bold 30px Montserrat";
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.textAlign = "center";

            for (let i = 0; i < 20; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                ctx.fillText("SigmaGamblers", x, y);
            }

            canvas.toBlob(blob => {
                const reader = new FileReader();
                reader.onload = () => callback(reader.result); // base64
                reader.readAsDataURL(blob);
            }, "image/png");
        };
    }

    // --- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ ---
    function previewWatermarked() {
        const fileInput = document.getElementById("waterImageInput");
        if (!fileInput.files[0]) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");

        readFileAsDataURL(fileInput.files[0], imageData => {
            applyWatermark(imageData, watermarkedData => {
                document.getElementById("waterPreview").src = watermarkedData;
                document.getElementById("waterPreview").style.display = "block";
                currentWatermarkedData = watermarkedData;
            });
        });
    }

    // --- –í—ã–±–æ—Ä –±–ª–æ–∫–∞ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ---
    function handleTargetSelect() {
        const block = document.getElementById("targetBlock").value;

        if (block === "reviews") {
            document.getElementById("reviewText_WM").placeholder = "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞";
        }
    }

    // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ—Ç–∑—ã–≤—ã —Å –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º ---
    function saveToReview() {
        const text = document.getElementById("reviewText_WM").value.trim();
        const author = document.getElementById("reviewAuthor_WM").value.trim();
        const rating = parseFloat(document.getElementById("reviewRating_WM").value.trim());

        if (!text || !author || !rating || !currentWatermarkedData) {
            alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ");
            return;
        }

        const id = Date.now();
        refPath(`reviews/${id}`).set({ text, author, rating, image: currentWatermarkedData }, err => {
            if (err) {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞");
            } else {
                alert("–û—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω —Å –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º");
                loadReviews();
                clearFields(["reviewText_WM", "reviewAuthor_WM", "reviewRating_WM"]);
                document.getElementById("targetBlock").value = "";
                document.getElementById("form-review").classList.add("hidden");
                currentWatermarkedData = null;
            }
        });
    }

    // --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞ –Ω–∞–ø—Ä—è–º—É—é ---
    function addReview() {
        const text = document.getElementById("reviewText").value.trim();
        const author = document.getElementById("reviewAuthor_WM").value.trim();
        const rating = parseFloat(document.getElementById("reviewRating_WM").value.trim());
        const fileInput = document.getElementById("reviewImageFile");
        const file = fileInput.files[0];

        if (!text || !author || !rating || !file) {
            alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ");
            return;
        }

        readFileAsDataURL(file, imageData => {
            const id = Date.now();
            refPath(`reviews/${id}`).set({ text, author, rating, image: imageData }, err => {
                if (err) {
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞");
                } else {
                    alert("–û—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω");
                    loadReviews();
                    clearFields(["reviewText", "reviewAuthor_WM", "reviewRating_WM"]);
                    fileInput.value = "";
                }
            });
        });
    }

    // --- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–∞ ---
    function editReview(id) {
        refPath(`reviews/${id}`).once("value", snap => {
            const data = snap.val();
            document.getElementById("reviewText").value = data.text;
            document.getElementById("reviewAuthor_WM").value = data.author;
            document.getElementById("reviewRating_WM").value = data.rating;

            document.getElementById("reviewImageFile").onchange = () => {
                const file = document.getElementById("reviewImageFile").files[0];
                if (!file) return;

                readFileAsDataURL(file, imageData => {
                    refPath(`reviews/${id}`).update({
                        text: document.getElementById("reviewText").value,
                        author: document.getElementById("reviewAuthor_WM").value,
                        rating: parseFloat(document.getElementById("reviewRating_WM").value),
                        image: imageData
                    }, err => {
                        if (err) {
                            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏");
                        } else {
                            alert("–û—Ç–∑—ã–≤ –æ–±–Ω–æ–≤–ª—ë–Ω");
                            document.getElementById("reviewImageFile").onchange = null;
                            loadReviews();
                            clearFields(["reviewText", "reviewAuthor_WM", "reviewRating_WM"]);
                            document.getElementById("reviewImageFile").value = "";
                        }
                    });
                });
            };
        });
    }

    // --- –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞ ---
    function deleteReview(id) {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤?")) {
            refPath(`reviews/${id}`).remove(() => loadReviews());
        }
    }

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ ---
    function loadReviews() {
        refPath("reviews").on("value", snapshot => {
            const container = document.getElementById("reviewsList");
            container.innerHTML = "<h3>–û—Ç–∑—ã–≤—ã</h3>";

            if (!snapshot.exists()) return;

            snapshot.forEach(child => {
                const r = child.val();
                const div = document.createElement("div");
                div.className = "review-block";
                div.innerHTML = `
                    "${r.text}" ‚Äî ${r.author}<br>
                    ‚≠ê ${r.rating}<br>
                    <img src="${r.image}" width="100%"><br>
                    <div class="actions">
                        <button onclick="editReview('${child.key}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button onclick="deleteReview('${child.key}')">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>`;
                container.appendChild(div);
            });
        });
    }

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
    function clearFields(ids) {
        ids.forEach(id => document.getElementById(id).value = "");
    }

    window.onload = () => {
        document.getElementById("waterOpacity")?.addEventListener("input", e => {
            document.getElementById("opacityValue").innerText = e.target.value;
        });

        loadReviews();
    };
</script>
</body>
    </html>
