<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–ê–¥–º–∏–Ω–∫–∞ MoonStudio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet"/>
    <style>
        body {
            margin: 0;
            background: #111;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            padding: 40px;
        }

        .dashboard {
            max-width: 500px;
            margin: auto;
            background: #222;
            padding: 30px;
            border-radius: 10px;
        }

        input, textarea, button {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            font-size: 14px;
        }

        button {
            background: #ff6b6b;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        .list-item {
            background: #333;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
        }

        .rating-stars {
            color: gold;
            margin-top: 5px;
        }

        .actions {
            margin-top: 10px;
        }

        .actions button {
            margin-right: 5px;
        }
    </style>
</head>
<body>

<div class="dashboard">
    <!-- –õ–æ–≥–æ—Ç–∏–ø -->
    <h2>–ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø</h2>
    <input type="file" id="logoFile" accept="image/*">
    <img id="currentLogo" src="" alt="–õ–æ–≥–æ—Ç–∏–ø" width="100" style="margin-top:10px;">
    <button onclick="uploadLogo()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button><hr>

    <!-- –û—Ç–∑—ã–≤—ã -->
    <h2>–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h2>
    <textarea id="reviewText" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞"></textarea>
    <input type="text" id="reviewAuthor" placeholder="–ò–º—è –∞–≤—Ç–æ—Ä–∞">
    <input type="number" id="reviewRating" min="1" max="5" step="0.1" placeholder="–†–µ–π—Ç–∏–Ω–≥ (1-5)">
    <input type="file" id="reviewImageFile" accept="image/*">
    <button onclick="addReview()">–î–æ–±–∞–≤–∏—Ç—å</button>
    <div id="reviewsList"></div><hr>

    <!-- –£—Å–ª—É–≥–∏ -->
    <h2>–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</h2>
    <input type="text" id="serviceName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏">
    <textarea id="serviceDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏"></textarea>
    <input type="file" id="serviceImageFile" accept="image/*">
    <button onclick="addService()">–î–æ–±–∞–≤–∏—Ç—å</button>
    <div id="servicesList"></div><hr>

    <!-- –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ -->
    <h2>–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É</h2>
    <input type="file" id="portfolioImageFile" accept="image/*">
    <button onclick="addPortfolio()">–î–æ–±–∞–≤–∏—Ç—å</button>
    <div id="portfolioList"></div><hr>

    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
    <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã</h2>
    <textarea id="contactInfo">Telegram: @yourusername<br>Email: example@example.com</textarea>
    <button onclick="saveContacts()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script>
    // üîë Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyCDaptwQubkzkAkHSSi_GpMhRHFasWFXvw",
        authDomain: "moonstudio-db.firebaseapp.com",
        databaseURL: "https://moonstudio-db-default-rtdb.firebaseio.com",
        projectId: "moonstudio-db",
        storageBucket: "moonstudio-db.firebasestorage.app",
        messagingSenderId: "154686593917",
        appId: "1:154686593917:web:c777e00ae5096e048eca14"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function refPath(path) {
        return db.ref(path);
    }

    // --- –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ ---
    function readFileAsDataURL(file, callback) {
        const reader = new FileReader();
        reader.onload = e => callback(e.target.result);
        reader.readAsDataURL(file);
    }

    // --- –ù–∞–ª–æ–∂–µ–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ ---
    async function applyWatermark(imageUrl, logoUrl, text, callback) {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        const img = new Image();
        const logo = new Image();

        img.crossOrigin = "Anonymous";
        logo.crossOrigin = "Anonymous";

        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            // –ù–∞–ª–æ–∂–µ–Ω–∏–µ –ª–æ–≥–æ—Ç–∏–ø–∞
            logo.onload = () => {
                const logoSize = Math.min(canvas.width, canvas.height) * 0.2;
                ctx.globalAlpha = 0.2;
                ctx.drawImage(logo, canvas.width - logoSize - 20, canvas.height - logoSize - 20, logoSize, logoSize);
                ctx.globalAlpha = 1;

                // –ù–∞–¥–ø–∏—Å—å SigmaGamblers
                ctx.font = "bold 20px 'Press Start 2P'";
                ctx.fillStyle = "rgba(255, 255, 255, 0.3)";
                ctx.fillText(text, 20, canvas.height - 20);

                // –≠–∫—Å–ø–æ—Ä—Ç —Å –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º
                canvas.toBlob(blob => {
                    const reader = new FileReader();
                    reader.onload = () => callback(reader.result); // base64
                    reader.readAsDataURL(blob);
                }, "image/png");
            };
            logo.src = logoUrl || "https://via.placeholder.com/100x100?text=Logo";
        };
        img.src = imageUrl;
    }

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ—Ç–∏–ø–∞ ---
    function uploadLogo() {
        const fileInput = document.getElementById("logoFile");
        const file = fileInput.files[0];
        if (!file) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");

        readFileAsDataURL(file, imageData => {
            refPath("logo").set(imageData, err => {
                if (err) {
                    alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞");
                } else {
                    alert("–õ–æ–≥–æ—Ç–∏–ø –æ–±–Ω–æ–≤–ª—ë–Ω");
                    updateCurrentLogo();
                }
            });
        });
    }

    function updateCurrentLogo() {
        refPath("logo").once("value", snapshot => {
            document.getElementById("currentLogo").src = snapshot.val() || "https://via.placeholder.com/100x100?text=Logo";
        });
    }

    // --- –û—Ç–∑—ã–≤—ã ---
    async function addReview() {
        const text = document.getElementById("reviewText").value.trim();
        const author = document.getElementById("reviewAuthor").value.trim();
        const rating = parseFloat(document.getElementById("reviewRating").value.trim());
        const fileInput = document.getElementById("reviewImageFile");
        const file = fileInput.files[0];

        if (!text || !author || !rating || !file) {
            alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ");
            return;
        }

        // –ß–∏—Ç–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        readFileAsDataURL(file, imageData => {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –ª–æ–≥–æ—Ç–∏–ø
            refPath("logo").once("value", logoSnap => {
                const logoUrl = logoSnap.val() || "https://via.placeholder.com/100x100?text=Logo";

                // –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫
                applyWatermark(imageData, logoUrl, "SigmaGamblers", watermarkedData => {
                    const id = Date.now();
                    refPath(`reviews/${id}`).set({ text, author, rating, image: watermarkedData }, err => {
                        if (err) {
                            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞");
                        } else {
                            alert("–û—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω —Å –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º");
                            loadReviews();
                            clearFields(["reviewText", "reviewAuthor", "reviewRating"]);
                            fileInput.value = "";
                        }
                    });
                });
            });
        });
    }

    function deleteReview(id) {
        refPath(`reviews/${id}`).remove(() => loadReviews());
    }

    function loadReviews() {
        refPath("reviews").on("value", snapshot => {
            const container = document.getElementById("reviewsList");
            container.innerHTML = "";
            if (!snapshot.exists()) return;

            snapshot.forEach(child => {
                const r = child.val();
                const stars = renderStars(r.rating);

                const div = document.createElement("div");
                div.className = "list-item";
                div.innerHTML = `
                    "${r.text}" ‚Äî ${r.author}<br>
                    <small class="rating-stars">${stars}</small><br>
                    <img src="${r.image}" width="100"><br>
                    <button onclick="deleteReview('${child.key}')">–£–¥–∞–ª–∏—Ç—å</button>`;
                container.appendChild(div);
            });
        });
    }

    // --- –£—Å–ª—É–≥–∏ ---
    async function addService() {
        const title = document.getElementById("serviceName").value.trim();
        const description = document.getElementById("serviceDescription").value.trim();
        const fileInput = document.getElementById("serviceImageFile");
        const file = fileInput.files[0];

        if (!title || !description || !file) {
            alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
            return;
        }

        // –ß–∏—Ç–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        readFileAsDataURL(file, imageData => {
            // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–æ—Ç–∏–ø
            refPath("logo").once("value", logoSnap => {
                const logoUrl = logoSnap.val() || "https://via.placeholder.com/100x100?text=Logo";

                // –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫
                applyWatermark(imageData, logoUrl, "SigmaGamblers", watermarkedData => {
                    const id = Date.now();
                    refPath(`services/${id}`).set({ title, description, image: watermarkedData }, err => {
                        if (err) {
                            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏");
                        } else {
                            alert("–£—Å–ª—É–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º");
                            loadServices();
                            clearFields(["serviceName", "serviceDescription"]);
                            fileInput.value = "";
                        }
                    });
                });
            });
        });
    }

    function deleteService(id) {
        refPath(`services/${id}`).remove(() => loadServices());
    }

    function loadServices() {
        refPath("services").on("value", snapshot => {
            const container = document.getElementById("servicesList");
            container.innerHTML = "";
            if (!snapshot.exists()) return;

            snapshot.forEach(child => {
                const s = child.val();
                const div = document.createElement("div");
                div.className = "list-item";
                div.innerHTML = `
                    <strong>${s.title}</strong><br>${s.description}<br>
                    <img src="${s.image}" width="100"><br>
                    <button onclick="deleteService('${child.key}')">–£–¥–∞–ª–∏—Ç—å</button>`;
                container.appendChild(div);
            });
        });
    }

    // --- –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ ---
    async function addPortfolio() {
        const fileInput = document.getElementById("portfolioImageFile");
        const file = fileInput.files[0];
        if (!file) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");

        // –ß–∏—Ç–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        readFileAsDataURL(file, imageData => {
            // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–æ—Ç–∏–ø
            refPath("logo").once("value", logoSnap => {
                const logoUrl = logoSnap.val() || "https://via.placeholder.com/100x100?text=Logo";

                // –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫
                applyWatermark(imageData, logoUrl, "SigmaGamblers", watermarkedData => {
                    const id = Date.now();
                    refPath(`portfolio/${id}`).set({ image: watermarkedData }, err => {
                        if (err) {
                            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã");
                        } else {
                            alert("–†–∞–±–æ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º");
                            loadPortfolio();
                            fileInput.value = "";
                        }
                    });
                });
            });
        });
    }

    function deletePortfolio(id) {
        refPath(`portfolio/${id}`).remove(() => loadPortfolio());
    }

    function loadPortfolio() {
        refPath("portfolio").on("value", snapshot => {
            const container = document.getElementById("portfolioList");
            container.innerHTML = "";
            if (!snapshot.exists()) return;

            snapshot.forEach(child => {
                const p = child.val();
                const div = document.createElement("div");
                div.className = "list-item";
                div.innerHTML = `<img src="${p.image}" width="100"><br><button onclick="deletePortfolio('${child.key}')">–£–¥–∞–ª–∏—Ç—å</button>`;
                container.appendChild(div);
            });
        });
    }

    // --- –ö–æ–Ω—Ç–∞–∫—Ç—ã ---
    function saveContacts() {
        const info = document.getElementById("contactInfo").value;
        refPath("contacts").set(info, err => {
            if (err) {
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤");
            } else {
                alert("–ö–æ–Ω—Ç–∞–∫—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
            }
        });
    }

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
    function clearFields(ids) {
        ids.forEach(id => document.getElementById(id).value = "");
    }

    function renderStars(rating) {
        const fullStars = Math.floor(rating);
        const hasHalf = rating % 1 >= 0.5;
        let starsHTML = "";

        for (let i = 0; i < 5; i++) {
            if (i < fullStars) {
                starsHTML += "‚≠ê";
            } else if (hasHalf && i === fullStars) {
                starsHTML += "‚≠ê";
            } else {
                starsHTML += "‚òÜ";
            }
        }

        return `${starsHTML} (${rating})`;
    }

    async function checkPassword() {
        const input = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:");
        const hash = CryptoJS.SHA256(input).toString();
        if (hash !== "5c487d4a7d483e8d52435a3f8d3f3e8d") {
            alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
            location.reload();
        }
    }

    window.onload = async () => {
        await checkPassword();

        refPath("reviews").on("value", () => loadReviews());
        refPath("services").on("value", () => loadServices());
        refPath("portfolio").on("value", () => loadPortfolio());
        refPath("contacts").on("value", snap => {
            document.getElementById("contactInfo").value = snap.val() || "Telegram: @yourusername<br>Email: example@example.com";
        });

        refPath("logo").on("value", snap => {
            document.getElementById("currentLogo").src = snap.val() || "https://via.placeholder.com/100x100?text=Logo";
        });
    };
</script>

</body>
</html>
