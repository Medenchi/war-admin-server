<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–ê–¥–º–∏–Ω–∫–∞ SigmaGamblers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: sans-serif;
            background: #111;
            color: #fff;
            line-height: 1.6;
            padding: 20px;
        }

        .box {
            max-width: 400px;
            margin: auto;
            background: #222;
            padding: 20px;
            border-radius: 10px;
        }

        input, textarea, select, button {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            font-size: 14px;
        }

        button {
            background: #ff6b6b;
            color: white;
            border: none;
            cursor: pointer;
        }

        img.preview {
            width: 100%;
            margin-top: 10px;
            display: block;
        }

        .list {
            margin-top: 30px;
        }

        .item {
            background: #333;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
        }

        .controls {
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="box">
    <h2 style="text-align:center;color:#ff6b6b;">–í–û–¢–ï–†–ü–†–ï–û–ë–†–ê–ó–û–í–ê–õ–ö–ê</h2>
    <input type="file" id="imgInput" accept="image/*" onchange="previewWatermark()">
    <select id="typeSelect" onchange="toggleForm()">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
        <option value="reviews">–û—Ç–∑—ã–≤</option>
        <option value="services">–£—Å–ª—É–≥–∞</option>
        <option value="portfolio">–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ</option>
    </select>

    <div id="formContainer"></div>
    <img id="preview" src="" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" class="preview" style="display:none;">
</div>

<div class="box list" id="dataList">
    <h2 style="text-align:center;color:#ff6b6b;">–°–ø–∏—Å–æ–∫ –¥–∞–Ω–Ω—ã—Ö</h2>
    <div id="items"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script>
    // üîë Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyCDaptwQubkzkAkHSSi_GpMhRHFasWFXvw",
        authDomain: "moonstudio-db.firebaseapp.com",
        databaseURL: "https://moonstudio-db-default-rtdb.firebaseio.com",
        projectId: "moonstudio-db",
        storageBucket: "moonstudio-db.firebasestorage.app"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function refPath(path) {
        return db.ref(path);
    }

    let currentDataUrl = null;

    // --- –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ ---
    function readFile(e, callback) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => callback(ev.target.result);
        reader.readAsDataURL(file);
    }

    // --- –ù–∞–ª–æ–∂–µ–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ ---
    function applyWatermark(url, callback) {
        const c = document.createElement("canvas");
        const ctx = c.getContext("2d");
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.src = url;

        img.onload = () => {
            c.width = img.width;
            c.height = img.height;
            ctx.drawImage(img, 0, 0);

            // –•–∞–æ—Ç–∏—á–Ω—ã–π —Ç–µ–∫—Å—Ç
            ctx.font = "bold 30px sans-serif";
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.textAlign = "center";

            for (let i = 0; i < 20; i++) {
                const x = Math.random() * c.width;
                const y = Math.random() * c.height;
                ctx.fillText("SigmaGamblers", x, y);
            }

            // –≠–∫—Å–ø–æ—Ä—Ç –∫–∞–∫ base64
            c.toBlob(blob => {
                const fr = new FileReader();
                fr.onload = () => callback(fr.result);
                fr.readAsDataURL(blob);
            }, "image/png");
        };
    }

    // --- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º ---
    function previewWatermark() {
        const input = document.getElementById("imgInput");
        input.onchange = e => readFile(e, url => {
            applyWatermark(url, watermarked => {
                currentDataUrl = watermarked;
                document.getElementById("preview").src = watermarked;
                document.getElementById("preview").style.display = "block";
            });
        });

        if (input.files[0]) input.onchange({ target: input });
    }

    // --- –û—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã –ø–æ —Ç–∏–ø—É ---
    function toggleForm() {
        const type = document.getElementById("typeSelect").value;
        const formContainer = document.getElementById("formContainer");

        formContainer.innerHTML = "";
        if (!type) return;

        if (type === "reviews") {
            formContainer.innerHTML = `
                <textarea id="reviewText" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞"></textarea>
                <input type="text" id="reviewAuthor" placeholder="–ê–≤—Ç–æ—Ä">
                <input type="number" id="reviewRating" min="1" max="5" step="0.1" placeholder="–†–µ–π—Ç–∏–Ω–≥">
                <button onclick="saveReview()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–∑—ã–≤</button>`;
        } else if (type === "services") {
            formContainer.innerHTML = `
                <input type="text" id="serviceName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏">
                <textarea id="serviceDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
                <button onclick="saveService()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Å–ª—É–≥—É</button>`;
        } else if (type === "portfolio") {
            formContainer.innerHTML = `<button onclick="savePortfolio()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–±–æ—Ç—É</button>`;
        }
    }

    // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ---
    function saveReview() {
        const text = document.getElementById("reviewText").value.trim();
        const author = document.getElementById("reviewAuthor").value.trim();
        const rating = parseFloat(document.getElementById("reviewRating").value.trim());

        if (!text || !author || !rating || !currentDataUrl) {
            alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ");
            return;
        }

        const id = Date.now();
        refPath(`reviews/${id}`).set({ text, author, rating, image: currentDataUrl }, () => {
            alert("–û—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω");
            currentDataUrl = null;
            loadItems();
        });
    }

    function saveService() {
        const title = document.getElementById("serviceName").value.trim();
        const desc = document.getElementById("serviceDescription").value.trim();

        if (!title || !desc || !currentDataUrl) {
            alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ");
            return;
        }

        const id = Date.now();
        refPath(`services/${id}`).set({ title, description: desc, image: currentDataUrl }, () => {
            alert("–£—Å–ª—É–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞");
            currentDataUrl = null;
            loadItems();
        });
    }

    function savePortfolio() {
        if (!currentDataUrl) {
            alert("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ");
            return;
        }

        const id = Date.now();
        refPath(`portfolio/${id}`).set({ image: currentDataUrl }, () => {
            alert("–†–∞–±–æ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞");
            currentDataUrl = null;
            loadItems();
        });
    }

    // --- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä—è–º–æ –≤ —Å–ø–∏—Å–∫–µ ---
    function editItem(id, type) {
        refPath(`${type}/${id}`).once("value", snap => {
            const d = snap.val();
            const container = document.getElementById("items");

            const div = document.createElement("div");
            div.className = "item";
            div.innerHTML = `
                <strong>${type}</strong><br>
                ${type === "reviews" ? '<input id="editText" value="' + d.text + '" placeholder="–¢–µ–∫—Å—Ç"><input id="editAuthor" value="' + d.author + '" placeholder="–ê–≤—Ç–æ—Ä"><input id="editRating" value="' + d.rating + '" placeholder="–†–µ–π—Ç–∏–Ω–≥">' : ''}
                ${type === "services" ? '<input id="editTitle" value="' + d.title + '" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><textarea id="editDesc">' + d.description + '</textarea>' : ''}
                <input type="file" id="editImg-${id}" accept="image/*" onchange="readFile(event, url => applyWatermark(url, watermarked => {
                    refPath('${type}/${id}').update({ 
                        ${type === 'reviews' ? 'text: document.getElementById("editText").value,' : ''}
                        ${type === 'reviews' ? 'author: document.getElementById("editAuthor").value,' : ''}
                        ${type === 'reviews' ? 'rating: document.getElementById("editRating").value,' : ''}
                        ${type === 'services' ? 'title: document.getElementById("editTitle").value,' : ''}
                        ${type === 'services' ? 'description: document.getElementById("editDesc").value,' : ''}
                        image: watermarked
                    }, () => {
                        alert('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
                        loadItems();
                    });
                }))">
                <button onclick="deleteItem('${id}', '${type}')">–£–¥–∞–ª–∏—Ç—å</button>
            `;
            container.appendChild(div);
        });
    }

    function deleteItem(id, type) {
        refPath(`${type}/${id}`).remove(() => loadItems());
    }

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---
    function loadItems() {
        const container = document.getElementById("items");
        container.innerHTML = "";

        ["reviews", "services", "portfolio"].forEach(type => {
            refPath(type).on("value", snap => {
                if (!snap.exists()) return;

                snap.forEach(child => {
                    const d = child.val();
                    const div = document.createElement("div");
                    div.className = "item";
                    div.innerHTML = `
                        <strong>${type}</strong><br>
                        ${type === "reviews" ? `"${d.text}" ‚Äî ${d.author} ‚≠ê ${d.rating}<br>` : ''}
                        ${type === "services" ? `${d.title}: ${d.description}<br>` : ''}
                        <img src="${d.image}" width="100"><br>
                        <div class="controls">
                            <input type="file" id="editImg-${child.key}" accept="image/*" onchange="readFile(event, url => applyWatermark(url, watermarked => {
                                refPath('${type}/${child.key}').update({
                                    ${type === 'reviews' ? 'text: document.getElementById("editText").value,' : ''}
                                    ${type === 'reviews' ? 'author: document.getElementById("editAuthor").value,' : ''}
                                    ${type === 'reviews' ? 'rating: document.getElementById("editRating").value,' : ''}
                                    ${type === 'services' ? 'title: document.getElementById("editTitle").value,' : ''}
                                    ${type === 'services' ? 'description: document.getElementById("editDesc").value,' : ''}
                                    image: watermarked
                                }, () => {
                                    alert('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
                                    loadItems();
                                });
                            }))">
                            ${type === "reviews" ? '<input id="editText" value="' + d.text + '" placeholder="–¢–µ–∫—Å—Ç"><input id="editAuthor" value="' + d.author + '" placeholder="–ê–≤—Ç–æ—Ä"><input id="editRating" value="' + d.rating + '" placeholder="–†–µ–π—Ç–∏–Ω–≥">' : ''}
                            ${type === "services" ? '<input id="editTitle" value="' + d.title + '" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><textarea id="editDesc">' + d.description + '</textarea>' : ''}
                            <button onclick="deleteItem('${child.key}', '${type}')">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            });
        });
    }

    window.onload = () => {
        loadItems();
    };
</script>

</body>
</html>
