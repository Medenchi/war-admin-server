<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–ê–¥–º–∏–Ω–∫–∞ SigmaGamblers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: sans-serif;
            background: #111;
            color: #fff;
            line-height: 1.6;
            padding: 20px;
        }

        .dashboard {
            max-width: 500px;
            margin: auto;
            background: #222;
            padding: 20px;
            border-radius: 10px;
        }

        input, textarea, button, select {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            font-size: 14px;
        }

        button {
            background: #ff6b6b;
            color: white;
            border: none;
            cursor: pointer;
        }

        h2.section-title {
            text-align: center;
            margin-bottom: 20px;
            color: #ff6b6b;
        }

        .block-item {
            background: #333;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .actions {
            margin-top: 10px;
        }

        .actions button {
            margin-right: 10px;
            font-size: 14px;
            padding: 6px 10px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

<div class="dashboard">

    <!-- –í–æ—Ç–µ—Ä–ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–ª–∫–∞ -->
    <h2 style="text-align:center;color:#ff6b6b;">–í–û–¢–ï–†–ü–†–ï–û–ë–†–ê–ó–û–í–ê–õ–ö–ê</h2>
    <input type="file" id="waterImageInput" accept="image/*" onchange="previewWatermarked()">
    <select id="targetBlock" onchange="handleTargetSelect()">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
        <option value="reviews">–û—Ç–∑—ã–≤</option>
        <option value="services">–£—Å–ª—É–≥–∞</option>
        <option value="portfolio">–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ</option>
        <option value="team">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</option>
    </select><br>

    <div style="text-align:center;">
        <p>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:</p>
        <img id="waterPreview" src="" alt="–° –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º" style="display:none;max-width:100%;">
    </div><hr>

    <!-- –§–æ—Ä–º—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <div id="form-review" class="hidden">
        <textarea id="reviewText_WM" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞"></textarea>
        <input type="text" id="reviewAuthor_WM" placeholder="–ê–≤—Ç–æ—Ä">
        <input type="number" id="reviewRating_WM" min="1" max="5" step="0.1" placeholder="–†–µ–π—Ç–∏–Ω–≥">
        <button onclick="saveToReview()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ—Ç–∑—ã–≤—ã</button>
    </div>

    <div id="form-service" class="hidden">
        <input type="text" id="serviceName_WM" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏">
        <textarea id="serviceDescription_WM" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
        <button onclick="saveToService()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —É—Å–ª—É–≥–∏</button>
    </div>

    <div id="form-portfolio" class="hidden">
        <button onclick="saveToPortfolio()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ</button>
    </div>

    <div id="form-team" class="hidden">
        <input type="text" id="memberName_WM" placeholder="–ò–º—è">
        <input type="text" id="memberPosition_WM" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å">
        <input type="text" id="memberTelegram_WM" placeholder="Telegram (–±–µ–∑ @)">
        <button onclick="saveToTeam()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É</button>
    </div><hr>

    <!-- –°–ø–∏—Å–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ -->
    <h2 style="text-align:center;margin-bottom:20px;color:#ff6b6b;">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ</h2>
    <div id="reviewsList"></div>
    <div id="servicesList"></div>
    <div id="portfolioList"></div>
    <div id="teamList"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCDaptwQubkzkAkHSSi_GpMhRHFasWFXvw",
        authDomain: "moonstudio-db.firebaseapp.com",
        databaseURL: "https://moonstudio-db-default-rtdb.firebaseio.com",
        projectId: "moonstudio-db"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    function refPath(p) { return db.ref(p); }

    let currentWatermarkedData = null;

    function readFile(e, callback) {
        const r = new FileReader();
        r.onload = () => callback(r.result);
        r.readAsDataURL(e.target.files[0]);
    }

    function applyWatermark(url, callback) {
        const cv = document.createElement("canvas");
        const ctx = cv.getContext("2d");

        const img = new Image();
        img.crossOrigin = "Anonymous"; // üîë –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!
        img.src = url;

        img.onload = () => {
            cv.width = img.width;
            cv.height = img.height;
            ctx.drawImage(img, 0, 0);

            ctx.font = "bold 30px sans-serif";
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.textAlign = "center";

            for (let i = 0; i < 20; i++) {
                const x = Math.random() * cv.width;
                const y = Math.random() * cv.height;
                ctx.fillText("SigmaGamblers", x, y);
            }

            cv.toBlob(blob => {
                const fr = new FileReader();
                fr.onload = () => callback(fr.result); // base64
                fr.readAsDataURL(blob);
            }, "image/png");
        };
    }

    function previewWatermarked() {
        const f = document.getElementById("waterImageInput");
        if (!f.files[0]) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ");

        readFile(f, d => {
            applyWatermark(d, w => {
                document.getElementById("waterPreview").src = w;
                document.getElementById("waterPreview").style.display = "block";
                currentWatermarkedData = w;
            });
        });
    }

    function handleTargetSelect() {
        const block = document.getElementById("targetBlock").value;
        document.querySelectorAll("[id^='form-']").forEach(el => el.classList.add("hidden"));
        if (block) document.getElementById("form-" + block).classList.remove("hidden");
    }

    function saveToReview() {
        const t = document.getElementById("reviewText_WM").value.trim();
        const a = document.getElementById("reviewAuthor_WM").value.trim();
        const r = parseFloat(document.getElementById("reviewRating_WM").value.trim());

        if (!t || !a || !r || !currentWatermarkedData) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ");

        const id = Date.now();
        refPath(`reviews/${id}`).set({ text:t, author:a, rating:r, image:currentWatermarkedData }, () => {
            alert("–û—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω"); loadReviews();
            clearFields(["reviewText_WM", "reviewAuthor_WM", "reviewRating_WM"]);
            document.getElementById("targetBlock").value = "";
            document.querySelectorAll("[id^='form-']").forEach(el => el.classList.add("hidden"));
            currentWatermarkedData = null;
        });
    }

    function saveToService() {
        const t = document.getElementById("serviceName_WM").value.trim();
        const d = document.getElementById("serviceDescription_WM").value.trim();

        if (!t || !d || !currentWatermarkedData) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ");

        const id = Date.now();
        refPath(`services/${id}`).set({ title:t, description:d, image:currentWatermarkedData }, () => {
            alert("–£—Å–ª—É–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞"); loadServices();
            clearFields(["serviceName_WM", "serviceDescription_WM"]);
            document.getElementById("targetBlock").value = "";
            document.querySelectorAll("[id^='form-']").forEach(el => el.classList.add("hidden"));
            currentWatermarkedData = null;
        });
    }

    function saveToPortfolio() {
        if (!currentWatermarkedData) return alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ");

        const id = Date.now();
        refPath(`portfolio/${id}`).set({ image:currentWatermarkedData }, () => {
            alert("–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ"); loadPortfolio();
            document.getElementById("targetBlock").value = "";
            document.getElementById("form-portfolio").classList.add("hidden");
            currentWatermarkedData = null;
        });
    }

    function saveToTeam() {
        const name = document.getElementById("memberName_WM").value.trim();
        const pos = document.getElementById("memberPosition_WM").value.trim();
        const tel = document.getElementById("memberTelegram_WM").value.trim();

        if (!name || !pos || !currentWatermarkedData) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å");

        const id = Date.now();
        refPath(`team/${id}`).set({ name, position:pos, telegram:tel, avatar:currentWatermarkedData }, () => {
            alert("–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω"); loadTeam();
            clearFields(["memberName_WM", "memberPosition_WM", "memberTelegram_WM"]);
            document.getElementById("targetBlock").value = "";
            document.getElementById("form-team").classList.add("hidden");
            currentWatermarkedData = null;
        });
    }

    function editItem(id, type) {
        refPath(`${type}/${id}`).once("value", snap => {
            const data = snap.val();
            if (!data) return;

            if (type === "reviews") {
                document.getElementById("reviewText_WM").value = data.text;
                document.getElementById("reviewAuthor_WM").value = data.author;
                document.getElementById("reviewRating_WM").value = data.rating;
                document.getElementById("targetBlock").value = "reviews";
                document.getElementById("form-review").classList.remove("hidden");
                currentWatermarkedData = data.image;
            } else if (type === "services") {
                document.getElementById("serviceName_WM").value = data.title;
                document.getElementById("serviceDescription_WM").value = data.description;
                document.getElementById("targetBlock").value = "services";
                document.getElementById("form-service").classList.remove("hidden");
                currentWatermarkedData = data.image;
            } else if (type === "portfolio") {
                document.getElementById("targetBlock").value = "portfolio";
                document.getElementById("form-portfolio").classList.remove("hidden");
                currentWatermarkedData = data.image;
            } else if (type === "team") {
                document.getElementById("memberName_WM").value = data.name;
                document.getElementById("memberPosition_WM").value = data.position;
                document.getElementById("memberTelegram_WM").value = data.telegram;
                document.getElementById("targetBlock").value = "team";
                document.getElementById("form-team").classList.remove("hidden");
                currentWatermarkedData = data.avatar;
            }
        });
    }

    function deleteItem(id, type) {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã?")) {
            refPath(`${type}/${id}`).remove(() => window[`load${type.charAt(0).toUpperCase()+type.slice(1)]`();
        });
    }

    function loadData(path, containerId, template) {
        refPath(path).on("value", snap => {
            const container = document.getElementById(containerId);
            container.innerHTML = `<h3>${containerId}</h3>`;
            if (!snap.exists()) return;

            snap.forEach(child => {
                const d = child.val();
                const div = document.createElement("div");
                div.className = "block-item";
                div.innerHTML = template(d, child.key);
                container.appendChild(div);
            });
        });
    }

    function loadReviews() {
        loadData("reviews", "reviewsList", d => `
            "${d.text}" ‚Äî ${d.author}<br>‚≠ê ${d.rating}<br>
            <img src="${d.image}" width="100%"><br>
            <div class="actions">
                <button onclick="editItem('${child.key}', 'reviews')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button onclick="deleteItem('${child.key}', 'reviews')">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        `);
    }

    function loadServices() {
        loadData("services", "servicesList", d => `
            <strong>${d.title}</strong><br>${d.description}<br>
            <img src="${d.image}" width="100%"><br>
            <div class="actions">
                <button onclick="editItem('${child.key}', 'services')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button onclick="deleteItem('${child.key}', 'services')">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        `);
    }

    function loadPortfolio() {
        loadData("portfolio", "portfolioList", d => `
            <img src="${d.image}" width="100%"><br>
            <div class="actions">
                <button onclick="editItem('${child.key}', 'portfolio')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button onclick="deleteItem('${child.key}', 'portfolio')">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        `);
    }

    function loadTeam() {
        loadData("team", "teamList", d => `
            <img src="${d.avatar}" width="100%"><br><strong>${d.name}</strong><br>${d.position}<br>
            ${d.telegram ? `<a href="https://t.me/${d.telegram}" target="_blank">@${d.telegram}</a><br>` : ''}
            <div class="actions">
                <button onclick="editItem('${child.key}', 'team')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button onclick="deleteItem('${child.key}', 'team')">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        `);
    }

    function clearFields(ids) {
        ids.forEach(id => document.getElementById(id).value = "");
    }

    window.onload = () => {
        document.getElementById("waterImageInput").onchange = previewWatermarked;
        document.getElementById("targetBlock").onchange = handleTargetSelect;

        loadReviews();
        loadServices();
        loadPortfolio();
        loadTeam();
    };
</script>
</body>
</html>
